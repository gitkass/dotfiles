stages:
  - build
  - release

.nix_flake_job:
  image: nixos/nix:latest
  
  # # Configure caching for the Nix store and potentially other dependencies
  # cache:
  #   key:
  #     files:
  #       - flake.lock
  #   paths:
  #     - .direnv/
  #     - .git/
  #     - /nix/store
  #   policy: pull-push
  
  # Before running the script, ensure Nix flakes are enabled and 
  # simulate the 'direnv allow' using 'nix develop' to load the environment.
  # Direnv itself is usually not installed on CI runners, but we use the 
  # underlying 'nix develop' command to get the environment defined in flake.nix.
  before_script:
    - mkdir -p .direnv  # Create the directory for nix-direnv (optional but good practice)
    - nix --experimental-features "nix-command flakes" develop --command /bin/bash -c "echo 'Nix environment loaded.'"
    - export PATH="$HOME/.nix-profile/bin:$PATH" # Ensure nix binaries are in path (might be redundant but safer)
    - nix --experimental-features "nix-command flakes" build # Optionally build the default output to ensure dependencies are fetched

# --- Job 1: Check (for Merge Requests) ---
check:
  extends: .nix_flake_job
  stage: build
  
  # Only run for merge requests (MRs)
  rules:
    - if: $CI_MERGE_REQUEST_IID
  
  script:
    # Use 'nix develop --command' to run 'task check' within the dev environment
    - nix --experimental-features "nix-command flakes" develop --command /bin/bash -c "task check"

# --- Job 2: Release (for tags matching 'release/*') ---
release:
  stage: release
  # Using the official goreleaser image for simplicity.
  # This image includes git and Go, and will handle the release.
  image: 
    name: goreleaser/goreleaser:latest
    entrypoint: [""] # Important to override the default entrypoint
  
  # Only run for tags that match the specified pattern
  rules:
    - if: $CI_COMMIT_TAG =~ /^release\/.*/
  
  # Disable shallow clone so goreleaser can generate a proper changelog from git history
  variables:
    GIT_DEPTH: "0"
  
  script:
    # 1. Check for the required GitLab token
    - if [ -z "$GITLAB_TOKEN" ]; then echo "GITLAB_TOKEN variable is required for GoReleaser to create a release."; exit 1; fi
    
    # 2. Run goreleaser
    # --clean removes temporary files afterward
    # GITLAB_TOKEN is used by goreleaser to interact with the GitLab API
    - goreleaser release --clean
